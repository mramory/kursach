<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка - Подкаст Сервис</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        .admin-section {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-mic"></i> Подкаст Сервис - Админка
            </a>
        </div>
    </nav>

    <div id="login-section" class="login-container">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title text-center mb-4">Вход в админку</h3>
                <form id="login-form">
                    <div class="mb-3">
                        <label for="username" class="form-label">Логин</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Пароль</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Войти</button>
                </form>
                <div id="login-error" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div id="admin-section" class="admin-section container my-5">
        <div class="row">
            <div class="col-md-6">
                <h3>Управление подкастами</h3>
                <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addPodcastModal">
                    <i class="bi bi-plus-circle"></i> Добавить подкаст
                </button>
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="search-podcasts-input" 
                           placeholder="Поиск подкастов..." 
                           onkeyup="handlePodcastSearch(event)">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearPodcastSearch()">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                <div id="podcasts-list"></div>
                <div id="podcasts-no-results" class="text-center text-muted" style="display: none;">
                    <i class="bi bi-search" style="font-size: 2rem;"></i>
                    <p class="mt-2">Подкасты не найдены</p>
                </div>
            </div>
            <div class="col-md-6">
                <h3>Управление эпизодами</h3>
                <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addEpisodeModal">
                    <i class="bi bi-plus-circle"></i> Добавить эпизод
                </button>
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="search-episodes-input" 
                           placeholder="Поиск эпизодов..." 
                           onkeyup="handleEpisodeSearch(event)">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearEpisodeSearch()">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                <div id="episodes-list"></div>
                <div id="episodes-no-results" class="text-center text-muted" style="display: none;">
                    <i class="bi bi-search" style="font-size: 2rem;"></i>
                    <p class="mt-2">Эпизоды не найдены</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addPodcastModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить подкаст</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-podcast-form">
                        <div class="mb-3">
                            <label class="form-label">Название</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Автор</label>
                            <input type="text" class="form-control" name="author">
                        </div>
                        <button type="submit" class="btn btn-primary">Добавить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addEpisodeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить эпизод</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-episode-form">
                        <div class="mb-3">
                            <label class="form-label">Подкаст</label>
                            <select class="form-control" name="podcast_id" id="podcast-select" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Название</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">URL аудио файла</label>
                            <input type="text" class="form-control" name="audio_file" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Номер эпизода</label>
                            <input type="number" class="form-control" name="episode_number" value="1">
                        </div>
                        <button type="submit" class="btn btn-primary">Добавить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editPodcastModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Редактировать подкаст</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-podcast-form">
                        <input type="hidden" name="id" id="edit-podcast-id">
                        <div class="mb-3">
                            <label class="form-label">Название</label>
                            <input type="text" class="form-control" name="title" id="edit-podcast-title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" name="description" id="edit-podcast-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Автор</label>
                            <input type="text" class="form-control" name="author" id="edit-podcast-author">
                        </div>
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editEpisodeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Редактировать эпизод</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-episode-form">
                        <input type="hidden" name="id" id="edit-episode-id">
                        <div class="mb-3">
                            <label class="form-label">Подкаст</label>
                            <select class="form-control" name="podcast_id" id="edit-episode-podcast-select" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Название</label>
                            <input type="text" class="form-control" name="title" id="edit-episode-title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" name="description" id="edit-episode-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">URL аудио файла</label>
                            <input type="text" class="form-control" name="audio_file" id="edit-episode-audio-file" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Номер эпизода</label>
                            <input type="number" class="form-control" name="episode_number" id="edit-episode-number" value="1">
                        </div>
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let podcastSearchTimeout;
        let episodeSearchTimeout;
        let allPodcasts = [];
        let allEpisodes = [];
        
        async function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('admin_logged_in');
            if (isLoggedIn === 'true') {
                showAdminSection();
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (data.success) {
                    sessionStorage.setItem('admin_logged_in', 'true');
                    showAdminSection();
                } else {
                    document.getElementById('login-error').style.display = 'block';
                    document.getElementById('login-error').textContent = data.message || 'Ошибка входа';
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        });

        function showAdminSection() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'block';
            loadPodcasts();
            loadEpisodes();
        }

        async function loadPodcasts(searchQuery = '') {
            try {
                let response;
                if (searchQuery) {
                    response = await fetch(`/api/search?q=${encodeURIComponent(searchQuery)}&type=podcasts`);
                    const data = await response.json();
                    allPodcasts = data.podcasts || [];
                } else {
                    response = await fetch('/api/podcasts');
                    allPodcasts = await response.json();
                }
                
                displayPodcasts(allPodcasts);
                
                const select = document.getElementById('podcast-select');
                select.innerHTML = '<option value="">Выберите подкаст</option>';
                allPodcasts.forEach(podcast => {
                    const option = document.createElement('option');
                    option.value = podcast.id;
                    option.textContent = podcast.title;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка загрузки подкастов:', error);
            }
        }
        
        function displayPodcasts(podcasts) {
            const container = document.getElementById('podcasts-list');
            const noResults = document.getElementById('podcasts-no-results');
            container.innerHTML = '';
            
            if (podcasts.length === 0) {
                container.style.display = 'none';
                noResults.style.display = 'block';
            } else {
                container.style.display = 'block';
                noResults.style.display = 'none';
                
                podcasts.forEach(podcast => {
                    const div = document.createElement('div');
                    div.className = 'card mb-2';
                    div.innerHTML = `
                        <div class="card-body">
                            <h5>${podcast.title}</h5>
                            <p class="text-muted">${podcast.description || 'Нет описания'}</p>
                            <p class="text-muted small">Автор: ${podcast.author || 'Неизвестен'}</p>
                            <button class="btn btn-sm btn-primary me-2" onclick="editPodcast(${podcast.id})">
                                <i class="bi bi-pencil"></i> Редактировать
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deletePodcast(${podcast.id})">
                                <i class="bi bi-trash"></i> Удалить
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }

        async function loadEpisodes(searchQuery = '') {
            try {
                let response;
                if (searchQuery) {
                    response = await fetch(`/api/search?q=${encodeURIComponent(searchQuery)}&type=episodes`);
                    const data = await response.json();
                    allEpisodes = data.episodes || [];
                } else {
                    response = await fetch('/api/episodes');
                    allEpisodes = await response.json();
                }
                
                displayEpisodes(allEpisodes);
            } catch (error) {
                console.error('Ошибка загрузки эпизодов:', error);
            }
        }
        
        function displayEpisodes(episodes) {
            const container = document.getElementById('episodes-list');
            const noResults = document.getElementById('episodes-no-results');
            container.innerHTML = '';
            
            if (episodes.length === 0) {
                container.style.display = 'none';
                noResults.style.display = 'block';
            } else {
                container.style.display = 'block';
                noResults.style.display = 'none';
                
                episodes.forEach(episode => {
                    const div = document.createElement('div');
                    div.className = 'card mb-2';
                    div.innerHTML = `
                        <div class="card-body">
                            <h5>${episode.title}</h5>
                            <p class="text-muted">Подкаст: ${episode.podcast_title}</p>
                            <p class="text-muted small">${episode.description || 'Нет описания'}</p>
                            <button class="btn btn-sm btn-primary me-2" onclick="editEpisode(${episode.id})">
                                <i class="bi bi-pencil"></i> Редактировать
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEpisode(${episode.id})">
                                <i class="bi bi-trash"></i> Удалить
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }
        
        function handlePodcastSearch(event) {
            clearTimeout(podcastSearchTimeout);
            const query = event.target.value.trim();
            
            podcastSearchTimeout = setTimeout(() => {
                loadPodcasts(query);
            }, 300);
        }
        
        function clearPodcastSearch() {
            document.getElementById('search-podcasts-input').value = '';
            loadPodcasts();
        }
        
        function handleEpisodeSearch(event) {
            clearTimeout(episodeSearchTimeout);
            const query = event.target.value.trim();
            
            episodeSearchTimeout = setTimeout(() => {
                loadEpisodes(query);
            }, 300);
        }
        
        function clearEpisodeSearch() {
            document.getElementById('search-episodes-input').value = '';
            loadEpisodes();
        }

        document.getElementById('add-podcast-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/podcasts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addPodcastModal')).hide();
                    e.target.reset();
                    loadPodcasts();
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        });

        document.getElementById('add-episode-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            data.podcast_id = parseInt(data.podcast_id);
            data.episode_number = parseInt(data.episode_number);

            try {
                const response = await fetch('/api/episodes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addEpisodeModal')).hide();
                    e.target.reset();
                    loadEpisodes();
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        });

        async function deletePodcast(id) {
            if (confirm('Удалить подкаст?')) {
                try {
                    await fetch(`/api/podcasts/${id}`, { 
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    loadPodcasts();
                    loadEpisodes();
                } catch (error) {
                    console.error('Ошибка:', error);
                }
            }
        }

        async function deleteEpisode(id) {
            if (confirm('Удалить эпизод?')) {
                try {
                    await fetch(`/api/episodes/${id}`, { 
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    loadEpisodes();
                } catch (error) {
                    console.error('Ошибка:', error);
                }
            }
        }

        async function editPodcast(id) {
            try {
                const response = await fetch(`/api/podcasts/${id}`);
                const podcast = await response.json();
                
                if (podcast) {
                    document.getElementById('edit-podcast-id').value = podcast.id;
                    document.getElementById('edit-podcast-title').value = podcast.title || '';
                    document.getElementById('edit-podcast-description').value = podcast.description || '';
                    document.getElementById('edit-podcast-author').value = podcast.author || '';
                    
                    const modal = new bootstrap.Modal(document.getElementById('editPodcastModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Ошибка загрузки подкаста:', error);
            }
        }

        async function editEpisode(id) {
            try {
                const episodesResponse = await fetch('/api/episodes');
                const allEpisodes = await episodesResponse.json();
                const episode = allEpisodes.find(e => e.id == id);
                
                if (episode) {
                    document.getElementById('edit-episode-id').value = episode.id;
                    document.getElementById('edit-episode-title').value = episode.title || '';
                    document.getElementById('edit-episode-description').value = episode.description || '';
                    document.getElementById('edit-episode-audio-file').value = episode.audio_file || '';
                    document.getElementById('edit-episode-number').value = episode.episode_number || 1;
                    
                    const select = document.getElementById('edit-episode-podcast-select');
                    select.innerHTML = '<option value="">Выберите подкаст</option>';
                    allPodcasts.forEach(podcast => {
                        const option = document.createElement('option');
                        option.value = podcast.id;
                        option.textContent = podcast.title;
                        option.selected = (podcast.id == episode.podcast_id);
                        select.appendChild(option);
                    });
                    
                    const modal = new bootstrap.Modal(document.getElementById('editEpisodeModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Ошибка загрузки эпизода:', error);
            }
        }

        document.getElementById('edit-podcast-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const id = data.id;

            try {
                const response = await fetch(`/api/podcasts/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: data.title,
                        description: data.description,
                        author: data.author
                    })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editPodcastModal')).hide();
                    e.target.reset();
                    document.getElementById('search-podcasts-input').value = '';
                    loadPodcasts();
                } else {
                    alert('Ошибка при сохранении: ' + (result.error || 'Неизвестная ошибка'));
                    console.error('Ошибка:', result);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка при сохранении подкаста');
            }
        });

        document.getElementById('edit-episode-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const id = data.id;
            data.podcast_id = parseInt(data.podcast_id);
            data.episode_number = parseInt(data.episode_number);

            try {
                const response = await fetch(`/api/episodes/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        podcast_id: data.podcast_id,
                        title: data.title,
                        description: data.description,
                        audio_file: data.audio_file,
                        episode_number: data.episode_number
                    })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editEpisodeModal')).hide();
                    e.target.reset();
                    document.getElementById('search-episodes-input').value = '';
                    loadEpisodes();
                } else {
                    alert('Ошибка при сохранении: ' + (result.error || 'Неизвестная ошибка'));
                    console.error('Ошибка:', result);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка при сохранении эпизода');
            }
        });

        checkAuth();
    </script>
</body>
</html>

